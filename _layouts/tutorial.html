{% comment %} Parse steps from single markdown file {% endcomment %}
{% assign raw_content = page.content %}

{% comment %} Split by "## Step " - note the space after Step {% endcomment %}
{% assign step_sections = raw_content | split: '## Step ' %}

{% comment %} First section is everything before first step, so total steps = size - 1 {% endcomment %}
{% assign total_steps = step_sections.size | minus: 1 %}

<!DOCTYPE html>
<html lang="{{ page.lang | default: 'en' }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ page.title | escape }} | {{ site.title | escape }}</title>
  <link rel="stylesheet" href="{{ '/assets/css/main.css' | relative_url }}">
  <script id="tutorial-config" type="application/json">
  {
    "tutorialName": {{ page.tutorial_name | jsonify }},
    "totalSteps": {{ total_steps }},
    "xpReward": {{ page.xp_reward | default: 100 }}
  }
  </script>
  <script>
    window.tutorialConfig = JSON.parse(document.getElementById('tutorial-config').textContent);
  </script>
  <style>
    .tutorial-content {
      display: none;
    }
    .tutorial-content.active {
      display: block;
    }
    .error-message {
      padding: 20px;
      background: #fee;
      border: 1px solid #fcc;
      border-radius: 8px;
      margin: 20px;
    }
  </style>
</head>
<body>
  {% include header.html %}
  
  <div class="main-container">
    {% include sidebar.html %}
    
    <main class="content-area">
      {% if total_steps <= 0 %}
        <div class="error-message">
          <h2>No Tutorial Steps Found</h2>
          <p>Please format your content with "## Step N: Title" headers.</p>
          <p>Example: <code>## Step 1: Getting Started</code></p>
          <p>Debug info: Found {{ step_sections.size }} sections, total_steps = {{ total_steps }}</p>
        </div>
      {% else %}
        {% comment %} Loop through each step section (skip first which is pre-content) {% endcomment %}
        {% for i in (1..total_steps) %}
          {% assign step_content = step_sections[i] %}
          {% assign step_lines = step_content | split: '
' %}
          
          {% comment %} First line should be "N: Title" {% endcomment %}
          {% assign first_line = step_lines[0] | strip %}
          
          {% comment %} Parse step number and title from "1: Title" format {% endcomment %}
          {% assign step_parts = first_line | split: ': ' %}
          {% assign step_number = step_parts[0] | strip %}
          {% assign step_title = step_parts[1] | default: 'Untitled' | strip %}
          
          {% comment %} Collect all remaining lines as body content {% endcomment %}
          {% assign step_body = '' %}
          {% for line_index in (1..step_lines.size) %}
            {% if line_index > 0 %}
              {% assign step_body = step_body | append: step_lines[line_index] | append: '
' %}
            {% endif %}
          {% endfor %}
          
          <div class="tutorial-content {% if i == 1 %}active{% endif %}" data-step="{{ step_number }}">
            <div class="tutorial-header">
              {% if i == 1 %}
                <div class="tutorial-meta">
                  {% if page.difficulty %}
                    <span class="difficulty-badge">{{ page.difficulty | escape }}</span>
                  {% endif %}
                  {% if page.duration %}
                    <span class="duration-badge">‚è± {{ page.duration | escape }}</span>
                  {% endif %}
                  {% if page.rating %}
                    <span class="rating">
                      <span class="stars">
                        {% for j in (1..page.rating) %}‚òÖ{% endfor %}
                      </span>
                      {% if page.rating_count %}
                        <span>({{ page.rating_count | number_with_delimiter }})</span>
                      {% endif %}
                    </span>
                  {% endif %}
                </div>
                <h1 class="tutorial-title">{{ page.title | escape }}</h1>
                {% if page.creator %}
                  <div class="creator-info">
                    <div class="creator-avatar">{{ page.creator | slice: 0 | upcase }}</div>
                    <span class="creator-name">Created by <a href="#">{{ page.creator | escape }}</a></span>
                  </div>
                {% endif %}
              {% else %}
                <h1 class="tutorial-title">Step {{ step_number }}: {{ step_title | escape }}</h1>
              {% endif %}
            </div>

            <div class="content-body">
              {{ step_body | markdownify }}
              
              <div class="complete-section">
                {% if i == total_steps %}
                  <button class="complete-button" onclick="completeStepAndFinish()">
                    Complete this tutorial & earn {{ page.xp_reward | default: 100 }} XP
                  </button>
                {% else %}
                  <button class="complete-button" onclick="completeStep()">
                    Mark as Complete & Continue
                  </button>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
        
        <div class="tutorial-content" data-step="complete">
          <div class="content-body" style="text-align: center; padding: 60px 40px;">
            <div style="font-size: 72px; margin-bottom: 20px;">üéâ</div>
            <h2 class="section-title" style="font-size: 32px;">Congratulations!</h2>
            <p class="content-text" style="font-size: 18px;">
              You've completed the "{{ page.title | escape }}" tutorial!
            </p>
            <div style="background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%); padding: 30px; border-radius: 16px; margin: 30px 0;">
              <h3>You Earned:</h3>
              <div style="font-size: 48px; font-weight: 700; background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                +{{ page.xp_reward | default: 100 }} XP
              </div>
            </div>
            <button class="nav-button next" onclick="window.location.href='{{ '/' | relative_url }}'">
              Back to Home ‚Üí
            </button>
          </div>
        </div>
      {% endif %}
    </main>
  </div>
  
  <script>
    // Tutorial navigation functions
    function showStep(stepNum) {
      document.querySelectorAll('.tutorial-content').forEach(el => {
        el.classList.remove('active');
      });
      const targetStep = document.querySelector(`[data-step="${stepNum}"]`);
      if (targetStep) {
        targetStep.classList.add('active');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }
    
    function completeStep() {
      const currentStep = document.querySelector('.tutorial-content.active');
      if (currentStep) {
        const stepNum = parseInt(currentStep.dataset.step);
        saveProgress(stepNum);
        showStep(stepNum + 1);
      }
    }
    
    function completeStepAndFinish() {
      const config = window.tutorialConfig;
      saveProgress(config.totalSteps);
      showStep('complete');
      awardXP(config.xpReward);
    }
    
    function saveProgress(stepNum) {
      const config = window.tutorialConfig;
      const progress = JSON.parse(localStorage.getItem('tutorialProgress') || '{}');
      progress[config.tutorialName] = stepNum;
      localStorage.setItem('tutorialProgress', JSON.stringify(progress));
    }
    
    function awardXP(xp) {
      const currentXP = parseInt(localStorage.getItem('totalXP') || '0');
      localStorage.setItem('totalXP', currentXP + xp);
    }
    
    // Load progress on page load
    document.addEventListener('DOMContentLoaded', function() {
      const config = window.tutorialConfig;
      const progress = JSON.parse(localStorage.getItem('tutorialProgress') || '{}');
      const savedStep = progress[config.tutorialName];
      
      if (savedStep && savedStep > 1 && savedStep <= config.totalSteps) {
        showStep(savedStep);
      }
    });
  </script>
  
  <script src="{{ '/assets/js/tutorial.js' | relative_url }}"></script>
</body>
</html>